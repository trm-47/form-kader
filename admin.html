<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel – Data Kader</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-6">

<h1 class="text-2xl font-bold mb-4 text-center">Admin Panel – Data Kader</h1>

<div class="mb-4 flex flex-wrap gap-4">
  <input type="text" id="search" placeholder="Search Nama / NIK / KTA..." class="border p-2 rounded-xl flex-1">
  
  <select id="filterPendidikanFormal" class="border p-2 rounded-xl">
    <option value="">Filter Pendidikan Formal</option>
    <option value="SD">SD</option>
    <option value="SMP">SMP</option>
    <option value="SMA">SMA</option>
    <option value="D1">D1</option>
    <option value="D2">D2</option>
    <option value="D3">D3</option>
    <option value="S1">S1</option>
    <option value="S2">S2</option>
    <option value="S3">S3</option>
  </select>

  <select id="filterPendidikanKader" class="border p-2 rounded-xl">
    <option value="">Filter Pendidikan Kader</option>
  </select>
</div>

<div class="overflow-x-auto">
  <table class="min-w-full bg-white rounded-xl shadow-lg overflow-hidden" id="table">
    <thead class="bg-red-700 text-white">
      <tr>
        <th class="px-4 py-2">Nama</th>
        <th class="px-4 py-2">NIK</th>
        <th class="px-4 py-2">KTA</th>
        <th class="px-4 py-2">Pendidikan Formal</th>
        <th class="px-4 py-2">Pendidikan Kader</th>
        <th class="px-4 py-2">Jabatan Partai</th>
        <th class="px-4 py-2">Organisasi</th>
        <th class="px-4 py-2">Skill</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<h2 class="text-xl font-bold mt-6 mb-2">Statistik</h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4" id="statCards"></div>
<canvas id="statChart"></canvas>

<script>
const endpoint = "PASTE_EXEC_URL_GAS_DISINI";
let allData = [];

async function fetchData(){
  try{
    const res = await axios.get(endpoint);
    allData = res.data;
    renderTable(allData);
    populateFilterKader();
    renderStats();
  }catch(err){
    console.error(err);
    alert("Gagal ambil data.");
  }
}

function renderTable(data){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  data.forEach(d=>{
    let pendidikanFormal = d.pendidikanFormal.map(p=>`${p.nama} (${p.tahun}) ${p.jurusan? '| '+p.jurusan:''}`).join('<br>') || '-';
    let pendidikanKader = d.pendidikanKader.map(p=>`${p.nama} (${p.tahun}) | ${p.penyelenggara}`).join('<br>') || '-';
    let jabatan = d.jabatanPartai.map(j=>`${j.nama} | ${j.tingkatan} | ${j.periode}`).join('<br>') || '-';
    let organisasi = d.organisasi.map(o=>`${o.nama} | ${o.jabatan} | ${o.tingkatan} | ${o.periode}`).join('<br>') || '-';
    let skill = `Bahasa: ${d.skillBahasa.join(", ")} | Komputer: ${d.kemampuanKomputer}`;

    const tr = document.createElement("tr");
    tr.className = "border-b cursor-pointer hover:bg-gray-100";
    tr.innerHTML = `
      <td class="px-4 py-2">${d.nama}</td>
      <td class="px-4 py-2">${d.nik}</td>
      <td class="px-4 py-2">${d.kta}</td>
      <td class="px-4 py-2">${pendidikanFormal}</td>
      <td class="px-4 py-2">${pendidikanKader}</td>
      <td class="px-4 py-2">${jabatan}</td>
      <td class="px-4 py-2">${organisasi}</td>
      <td class="px-4 py-2">${skill}</td>`;
    tbody.appendChild(tr);
  });
}

function populateFilterKader(){
  const filterKader = document.getElementById("filterPendidikanKader");
  let semuaDiklat = new Set();
  allData.forEach(d=>d.pendidikanKader.forEach(p=>semuaDiklat.add(p.nama)));
  filterKader.innerHTML = '<option value="">Filter Pendidikan Kader</option>' + Array.from(semuaDiklat).map(x=>`<option value="${x}">${x}</option>`).join('');
}

// Filter search & dropdown
document.getElementById("search").addEventListener("input", e=>{
  const q = e.target.value.toLowerCase();
  const filtered = allData.filter(d=>d.nama.toLowerCase().includes(q) || d.nik.includes(q) || d.kta.includes(q));
  renderTable(filtered);
});
document.getElementById("filterPendidikanFormal").addEventListener("change", e=>{
  const val = e.target.value;
  const filtered = val ? allData.filter(d=>d.pendidikanFormal.some(p=>p.jenjang===val)) : allData;
  renderTable(filtered);
});
document.getElementById("filterPendidikanKader").addEventListener("change", e=>{
  const val = e.target.value;
  const filtered = val ? allData.filter(d=>d.pendidikanKader.some(p=>p.nama===val)) : allData;
  renderTable(filtered);
});

// =======================
// Statistik
// =======================
function renderStats(){
  const total = allData.length;
  const statCards = document.getElementById("statCards");
  statCards.innerHTML = `
    <div class="bg-white p-4 rounded-xl shadow"><p class="text-gray-500">Total Kader</p><p class="text-xl font-bold">${total}</p></div>
    <div class="bg-white p-4 rounded-xl shadow"><p class="text-gray-500">SMA</p><p class="text-xl font-bold">${allData.filter(d=>d.pendidikanFormal.some(p=>p.jenjang==='SMA')).length}</p></div>
    <div class="bg-white p-4 rounded-xl shadow"><p class="text-gray-500">S1</p><p class="text-xl font-bold">${allData.filter(d=>d.pendidikanFormal.some(p=>p.jenjang==='S1')).length}</p></div>
    <div class="bg-white p-4 rounded-xl shadow"><p class="text-gray-500">Telah Diklat</p><p class="text-xl font-bold">${allData.filter(d=>d.pendidikanKader.length>0).length}</p></div>
  `;

  const ctx = document.getElementById("statChart").getContext("2d");
  new Chart(ctx,{
    type:"bar",
    data:{
      labels:["SMA","S1","S2","S3"],
      datasets:[{label:"Jumlah Kader",data:[
        allData.filter(d=>d.pendidikanFormal.some(p=>p.jenjang==='SMA')).length,
        allData.filter(d=>d.pendidikanFormal.some(p=>p.jenjang==='S1')).length,
        allData.filter(d=>d.pendidikanFormal.some(p=>p.jenjang==='S2')).length,
        allData.filter(d=>d.pendidikanFormal.some(p=>p.jenjang==='S3')).length,
      ],backgroundColor:"#ef4444"}]
    },
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}

fetchData();
</script>

</body>
</html>
