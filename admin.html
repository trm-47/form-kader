<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Data Kader</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .expand-row { display: none; }
  .pointer { cursor: pointer; }
</style>
</head>
<body class="bg-gray-100 font-sans">

<div class="max-w-7xl mx-auto p-4">
  <h1 class="text-2xl font-bold text-center mb-6">Admin Data Kader</h1>

  <div class="flex flex-col md:flex-row gap-4 mb-4">
    <input id="searchBox" type="text" placeholder="Search Nama, NIK, KTA..." 
      class="flex-1 p-2 border rounded-xl shadow-sm">

    <select id="filterPendidikan" class="p-2 border rounded-xl shadow-sm">
      <option value="">-- Filter Pendidikan Formal --</option>
    </select>

    <select id="filterDiklat" class="p-2 border rounded-xl shadow-sm">
      <option value="">-- Filter Diklat Partai --</option>
    </select>

    <button onclick="resetFilters()" class="px-4 py-2 bg-red-700 text-white rounded-xl">Reset</button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded-xl shadow overflow-hidden">
      <thead class="bg-red-700 text-white">
        <tr>
          <th class="p-3 text-left">#</th>
          <th class="p-3 text-left">Nama</th>
          <th class="p-3 text-left">NIK</th>
          <th class="p-3 text-left">KTA</th>
          <th class="p-3 text-left">Alamat</th>
          <th class="p-3 text-left">Tanggal Submit</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
const data = <?= JSON.stringify(data) ?>; // dari doGet()

let filteredData = [...data];

// buat filter dropdown otomatis dari data
function populateFilters() {
  const pendidikanSet = new Set();
  const diklatSet = new Set();

  data.forEach(d => {
    (d.pendidikanFormal || []).forEach(p => pendidikanSet.add(p.nama));
    (d.pendidikanKader || []).forEach(k => diklatSet.add(k.nama));
  });

  const selP = document.getElementById("filterPendidikan");
  pendidikanSet.forEach(val => {
    const opt = document.createElement("option");
    opt.value = val;
    opt.innerText = val;
    selP.appendChild(opt);
  });

  const selD = document.getElementById("filterDiklat");
  diklatSet.forEach(val => {
    const opt = document.createElement("option");
    opt.value = val;
    opt.innerText = val;
    selD.appendChild(opt);
  });
}

// render tabel
function renderTable() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  filteredData.forEach((d, i) => {
    // main row
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50 pointer";
    tr.onclick = () => {
      const next = tr.nextElementSibling;
      next.style.display = next.style.display === "table-row" ? "none" : "table-row";
    };

    tr.innerHTML = `
      <td class="p-2">${i+1}</td>
      <td class="p-2">${d.nama}</td>
      <td class="p-2">${d.nik}</td>
      <td class="p-2">${d.kta}</td>
      <td class="p-2">${d.alamat}</td>
      <td class="p-2">${new Date(d.tanggal).toLocaleDateString()}</td>
    `;
    tbody.appendChild(tr);

    // expand row
    const expandTr = document.createElement("tr");
    expandTr.className = "expand-row bg-gray-50";
    const td = document.createElement("td");
    td.colSpan = 6;
    td.className = "p-3 text-sm text-gray-700";

    td.innerHTML = `
      <b>Pendidikan Formal:</b> ${(d.pendidikanFormal || []).map(p => `${p.nama} (${p.tahun})`).join(", ") || "-"} <br>
      <b>Pendidikan Kader:</b> ${(d.pendidikanKader || []).map(k => `${k.nama} (${k.tahun})`).join(", ") || "-"} <br>
      <b>Jabatan Partai:</b> ${(d.jabatanPartai || []).map(j => `${j.nama} (${j.tingkatan}, ${j.periode})`).join(", ") || "-"} <br>
      <b>Organisasi:</b> ${(d.organisasi || []).map(o => `${o.nama} (${o.jabatan}, ${o.tingkatan}, ${o.periode})`).join(", ") || "-"} <br>
      <b>Skill Bahasa:</b> ${d.bahasa || "-"} <br>
      <b>Komputer:</b> ${d.komputer || "-"} <br>
      <b>Media Sosial:</b> ${d.medsos ? Object.entries(d.medsos).map(([k,v]) => `${k}: ${v}`).join(", ") : "-"}
    `;
    expandTr.appendChild(td);
    tbody.appendChild(expandTr);
  });
}

// search & filter
document.getElementById("searchBox").addEventListener("input", e => {
  const val = e.target.value.toLowerCase();
  filteredData = data.filter(d => 
    d.nama.toLowerCase().includes(val) || 
    d.nik.toLowerCase().includes(val) ||
    d.kta.toLowerCase().includes(val)
  );
  applyFilters();
});

document.getElementById("filterPendidikan").addEventListener("change", applyFilters);
document.getElementById("filterDiklat").addEventListener("change", applyFilters);

function applyFilters() {
  const pendidikanVal = document.getElementById("filterPendidikan").value;
  const diklatVal = document.getElementById("filterDiklat").value;

  filteredData = data.filter(d => {
    const pedMatch = pendidikanVal === "" || (d.pendidikanFormal || []).some(p => p.nama === pendidikanVal);
    const diklatMatch = diklatVal === "" || (d.pendidikanKader || []).some(k => k.nama === diklatVal);
    return pedMatch && diklatMatch;
  });

  const searchVal = document.getElementById("searchBox").value.toLowerCase();
  if(searchVal) {
    filteredData = filteredData.filter(d => 
      d.nama.toLowerCase().includes(searchVal) || 
      d.nik.toLowerCase().includes(searchVal) ||
      d.kta.toLowerCase().includes(searchVal)
    );
  }

  renderTable();
}

function resetFilters() {
  document.getElementById("searchBox").value = "";
  document.getElementById("filterPendidikan").value = "";
  document.getElementById("filterDiklat").value = "";
  filteredData = [...data];
  renderTable();
}

// init
populateFilters();
renderTable();

</script>

</body>
</html>
